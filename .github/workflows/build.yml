name: build-awg-userspace-ipk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: amnezia-vpn/amneziawg-go
          path: amneziawg-go

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Build linux arm64
        shell: bash
        run: |
          set -eux
          cd amneziawg-go
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="-s -w" -o ../amneziawg-go ./main.go

      - name: Build ipk
        shell: bash
        run: |
          set -eux
          VER="$(date -u +%Y%m%d%H%M%S)"
          PKG="amneziawg-go"
          ARCH="aarch64_cortex-a53_neon-vfpv4"
          ROOT="$PWD/pkgroot"
          rm -rf "$ROOT"
          mkdir -p "$ROOT/control" "$ROOT/data/usr/bin"
          cp -f amneziawg-go "$ROOT/data/usr/bin/amneziawg-go"
          chmod 0755 "$ROOT/data/usr/bin/amneziawg-go"

          cat > "$ROOT/control/control" << EOF
Package: ${PKG}
Version: 1.0-${VER}
Architecture: ${ARCH}
Maintainer: BE3600-AWG-KMOD
Description: AmneziaWG userspace (amneziawg-go) for GL-BE3600
Priority: optional
Section: net
EOF

          echo "2.0" > "$ROOT/debian-binary"
          (cd "$ROOT/control" && tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz .)
          (cd "$ROOT/data" && tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz .)
          ar r "${PKG}_1.0-${VER}_${ARCH}.ipk" "$ROOT/debian-binary" "$ROOT/control.tar.gz" "$ROOT/data.tar.gz"
          sha256sum "${PKG}_1.0-${VER}_${ARCH}.ipk" > "${PKG}_1.0-${VER}_${ARCH}.ipk.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: amneziawg-go-ipk
          path: |
            *.ipk
            *.sha256
