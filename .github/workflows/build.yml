name: Build kmod-amneziawg for GL-BE3600 (QSDK)

on:
  workflow_dispatch:
    inputs:
      glinet4x_tag:
        description: "Tag of glinet4.x matching your firmware (try v4.8.1 first)"
        required: true
        default: "v4.8.1"
      awg_openwrt_ref:
        description: "Branch/tag/commit of Slava-Shchipunov/awg-openwrt"
        required: true
        default: "master"

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev file wget ca-certificates

      - name: Checkout GL.iNet infra builder
        run: |
          set -eux
          git -c http.extraheader= \
              -c credential.helper= \
              -c core.askPass=true \
              -c GIT_TERMINAL_PROMPT=0 \
              clone --depth 1 https://github.com/gl-inet/gl-infra-builder.git /opt/gl-infra-builder

      - name: Prepare build tree for GL-BE3600
        env:
          GLINET_TAG: ${{ inputs.glinet4x_tag }}
        run: |
          set -eux
          cd /opt/gl-infra-builder

          # target for BE3600
          ./scripts/gen_config.py glinet_gl-be3600

          # bring GL.iNet packages and pin them to firmware tag
          cd /opt/gl-infra-builder/openwrt
          rm -rf package/glinet4.x || true
          git clone https://github.com/gl-inet/glinet4.x.git package/glinet4.x
          cd package/glinet4.x
          git fetch --tags
          git checkout "${GLINET_TAG}"

          # update feeds + toolchain
          cd /opt/gl-infra-builder
          make update
          make setup

      - name: Add awg-openwrt package
        env:
          AWG_REF: ${{ inputs.awg_openwrt_ref }}
        run: |
          set -eux
          cd /opt/gl-infra-builder/openwrt/package
          rm -rf awg-openwrt || true
          git clone https://github.com/Slava-Shchipunov/awg-openwrt.git awg-openwrt
          cd awg-openwrt
          git checkout "${AWG_REF}"

      - name: Build kmod-amneziawg only
        run: |
          set -eux
          cd /opt/gl-infra-builder/openwrt
          # build module package
          make package/kmod-amneziawg/compile -j"$(nproc)" V=s

      - name: Collect IPKs
        run: |
          set -eux
          cd /opt/gl-infra-builder/openwrt
          mkdir -p /tmp/out
          find bin/packages -type f -name "kmod-amneziawg_*.ipk" -print -exec cp -v {} /tmp/out/ \;
          # полезно часто: tools/uci/proto (если появятся)
          find bin/packages -type f -name "*amneziawg*.ipk" -print -exec cp -vn {} /tmp/out/ \; || true
          ls -lah /tmp/out

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BE3600-kmod-amneziawg-ipk
          path: /tmp/out/*.ipk
