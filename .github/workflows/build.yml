name: Build kmod-amneziawg for GL-BE3600 (QSDK)

on:
  workflow_dispatch:
    inputs:
      glinet4x_tag:
        description: "Tag of glinet4.x matching your firmware (try v4.8.1 first)"
        required: true
        default: "v4.8.1"
      awg_ref:
        description: "Branch/tag/commit of Slava-Shchipunov/awg-openwrt"
        required: true
        default: "master"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Install build deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev file wget ca-certificates git

      # 1) gl-infra-builder
      - name: Checkout gl-infra-builder
        uses: actions/checkout@v4
        with:
          repository: gl-inet/gl-infra-builder
          path: gl-infra-builder
          fetch-depth: 1

      # 2) glinet4.x (с тегами, чтобы можно было checkout tag)
      - name: Checkout glinet4.x
        uses: actions/checkout@v4
        with:
          repository: gl-inet/glinet4.x
          path: glinet4x
          fetch-depth: 0   # нужны теги

      - name: Checkout awg-openwrt
        uses: actions/checkout@v4
        with:
          repository: Slava-Shchipunov/awg-openwrt
          path: awg-openwrt
          fetch-depth: 0

      - name: Pin glinet4.x to tag
        working-directory: glinet4x
        run: |
          set -eux
          git checkout "${{ inputs.glinet4x_tag }}"
          git rev-parse --short HEAD

      - name: Pin awg-openwrt ref
        working-directory: awg-openwrt
        run: |
          set -eux
          git checkout "${{ inputs.awg_ref }}"
          git rev-parse --short HEAD

      # 3) подготовка дерева сборки BE3600
      - name: Prepare build tree for GL-BE3600
        working-directory: gl-infra-builder
        run: |
          set -eux
          ./scripts/gen_config.py glinet_gl-be3600
          make update
          make setup

      # 4) положить пакеты в openwrt/package
      - name: Inject glinet4.x + awg-openwrt into build tree
        run: |
          set -eux
          OWRT_DIR="$(pwd)/gl-infra-builder/openwrt"
          rm -rf "${OWRT_DIR}/package/glinet4.x" "${OWRT_DIR}/package/awg-openwrt" || true
          cp -a "$(pwd)/glinet4x" "${OWRT_DIR}/package/glinet4.x"
          cp -a "$(pwd)/awg-openwrt" "${OWRT_DIR}/package/awg-openwrt"
          ls -lah "${OWRT_DIR}/package" | head

      # 5) собрать kmod
      - name: Build kmod-amneziawg
        working-directory: gl-infra-builder/openwrt
        run: |
          set -eux
          make package/kmod-amneziawg/compile -j"$(nproc)" V=s

      # 6) собрать артефакт
      - name: Collect ipk
        run: |
          set -eux
          mkdir -p out
          find gl-infra-builder/openwrt/bin/packages -type f -name "kmod-amneziawg_*.ipk" -print -exec cp -v {} out/ \;
          ls -lah out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BE3600-kmod-amneziawg-ipk
          path: out/*.ipk
