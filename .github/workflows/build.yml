name: build-awg-userspace-ipk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: amnezia-vpn/amneziawg-go
          path: amneziawg-go

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Build linux arm64
        shell: bash
        run: |
          set -eux
          cd amneziawg-go
          VER="$(git rev-parse --short HEAD)"

          PKG=""
          if [ -d ./cmd ]; then
            if [ -d ./cmd/amneziawg-go ]; then PKG="./cmd/amneziawg-go"; fi
            if [ -z "$PKG" ] && [ -d ./cmd/awg-go ]; then PKG="./cmd/awg-go"; fi
          fi
          if [ -z "$PKG" ]; then PKG="."; fi

          VARPATH=""
          if git grep -nE 'var[[:space:]]+Version' -- '*.go' >/dev/null 2>&1; then
            for p in \
              "main.Version" \
              "cmd.Version" \
              "github.com/amnezia-vpn/amneziawg-go.Version" \
              "github.com/amnezia-vpn/amneziawg-go/main.Version" \
              "github.com/amnezia-vpn/amneziawg-go/cmd.Version"
            do
              VARPATH="$p"
              break
            done
          fi

          LDFLAGS="-s -w"
          if [ -n "$VARPATH" ]; then
            LDFLAGS="$LDFLAGS -X $VARPATH=$VER"
          fi

          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="$LDFLAGS" -o "$GITHUB_WORKSPACE/amneziawg-go" "$PKG"
          file "$GITHUB_WORKSPACE/amneziawg-go"

      - name: Build ipk
        shell: bash
        run: |
          set -eux
          VER="$(date -u +%Y%m%d%H%M%S)"
          PKG="amneziawg-go"
          ARCH="aarch64_cortex-a53_neon-vfpv4"
          ROOT="$PWD/pkgroot"
          rm -rf "$ROOT"
          mkdir -p "$ROOT/control" "$ROOT/data/usr/bin"
          cp -f "$GITHUB_WORKSPACE/amneziawg-go" "$ROOT/data/usr/bin/amneziawg-go"
          chmod 0755 "$ROOT/data/usr/bin/amneziawg-go"

          printf 'Package: %s\nVersion: 1.0-%s\nArchitecture: %s\nMaintainer: BE3600-AWG-KMOD\nDescription: AmneziaWG userspace (amneziawg-go) for GL-BE3600\nPriority: optional\nSection: net\n' \
            "$PKG" "$VER" "$ARCH" > "$ROOT/control/control"

          echo "2.0" > "$ROOT/debian-binary"
          (cd "$ROOT/control" && tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz .)
          (cd "$ROOT/data" && tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz .)

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends binutils

          ar r "${PKG}_1.0-${VER}_${ARCH}.ipk" "$ROOT/debian-binary" "$ROOT/control.tar.gz" "$ROOT/data.tar.gz"
          sha256sum "${PKG}_1.0-${VER}_${ARCH}.ipk" > "${PKG}_1.0-${VER}_${ARCH}.ipk.sha256"
          ls -lah *.ipk *.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: amneziawg-go-ipk
          path: |
            *.ipk
            *.sha256
